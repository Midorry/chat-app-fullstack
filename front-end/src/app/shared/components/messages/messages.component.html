<ng-container *ngIf="conversationId; else noConversation">
  <div class="chat-container">
    <!-- Header -->
    <div class="chat-header">
      <div class="chat-header-left">
        <button nz-button nzType="default" (click)="goBack()">
          <span nz-icon nzType="left" nzTheme="outline"></span>
        </button>
        <div>
          <h2>{{ otherUserData?.username }}</h2>
          <p>{{ otherUserData?.online ? "Online" : "Offline" }}</p>
        </div>
      </div>
      <div class="chat-header-right">
        <i nz-icon nzType="search" nzTheme="outline"></i>
        <i nz-icon nzType="phone" nzTheme="outline"></i>
        <i nz-icon nzType="more" nzTheme="outline"></i>
      </div>
    </div>

    <!-- Nội dung tin nhắn -->
    <div class="chat-messages-container" *ngIf="conversationId">
      <div class="chat-messages-list">
        <ng-container *ngIf="loadingMessages; else showMessages">
          <div
            *ngFor="let i of [0, 1, 2, 3]"
            class="message-item"
            [ngClass]="{
              'my-message': i % 2 === 1,
              'other-message': i % 2 === 0
            }"
          >
            <nz-avatar
              class="message-avatar"
              nzShape="square"
              [nzSize]="48"
              nzIcon="user"
            ></nz-avatar>

            <nz-skeleton
              [nzActive]="true"
              [nzParagraph]="{ rows: 1, width: '60%' }"
              [nzTitle]="false"
              [nzAvatar]="false"
              class="skeleton-bubble"
            ></nz-skeleton>
          </div>
        </ng-container>

        <ng-template #showMessages>
          <div
            #scrollContainer
            class="chat-messages-list"
            (scroll)="onScroll()"
          >
            <div class="top-loading" *ngIf="loading">
              <nz-spin nzSize="small"></nz-spin>
            </div>

            <!-- Group theo ngày -->
            <div *ngFor="let group of groupedMessages">
              <div class="date-header">
                <p></p>
                {{ group.date }}
                <p></p>
              </div>

              <div
                class="message-item"
                *ngFor="let msg of group.messages"
                [ngClass]="{
                  'my-message': msg.senderId._id === currentUserId,
                  'other-message': msg.senderId._id !== currentUserId
                }"
              >
                <nz-avatar
                  class="message-avatar"
                  nzShape="square"
                  [nzSize]="48"
                  [nzSrc]="msg.senderId.avatar ? msg.senderId.avatar : ''"
                  nzIcon="user"
                ></nz-avatar>

                <app-message
                  class="message-bubble"
                  [content]="msg.content"
                  [username]="msg.senderId.username"
                  [type]="msg.type"
                  [attachments]="msg.attachments"
                  [userId]="msg.senderId._id"
                  [sendTime]="msg.createdAt"
                ></app-message>
              </div>
            </div>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Ô nhập tin nhắn -->
    <div class="chat-input">
      <app-message-input [conversationId]="conversationId"></app-message-input>
    </div>
  </div>
</ng-container>

<ng-template #noConversation>
  <div class="chat-container">
    <div class="no-conversation">
      <p>Chọn một cuộc trò chuyện để bắt đầu nhắn tin</p>
    </div>
  </div>
</ng-template>
